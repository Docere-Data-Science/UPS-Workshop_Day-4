<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>The Tidymodels Framework</title>
    <meta charset="utf-8" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# The Tidymodels Framework

---






&lt;style type="text/css"&gt;
.red{ color: red; }
.blue{ color: blue; }
.huge {
  font-size: 200%;
}
.large {
  font-size: 150%;
}
.tiny {
  font-size: 50%;
}
&lt;/style&gt;


---
class: center, middle, inverse

# A workflow-based approach to modeling

---

## Workflow


0. **Clean** the data

--

1. **Specify** the model(s)

--

2. Create a **recipe** for pre-processing

--

3. Construct a **workflow** establishing the modeling process.

--

4. **Fit** the model

--

5. **Evaluate** the model fit.

---
class: center, middle, inverse

## Clean the data

---
## Clean the data


* Check data summaries and plots for anomalies.

--

* Are there any outliers that may be due to **data entry error**?

--

* Has **R** properly interpreted the *variable types*?

--

* Is the data in **tidy format**?

--

*Cleaning* (as opposed to *pre-processing*) = correcting "mistakes".

---

## Data: The NYC flights dataset


```r
library(nycflights13)

set.seed(384)

flights &lt;- flights %&gt;% sample_n(5000)

summary(flights)
```

```
##       year          month            day          dep_time    sched_dep_time
##  Min.   :2013   Min.   : 1.00   Min.   : 1.0   Min.   :   1   Min.   : 500  
##  1st Qu.:2013   1st Qu.: 4.00   1st Qu.: 8.0   1st Qu.: 908   1st Qu.: 910  
##  Median :2013   Median : 7.00   Median :16.0   Median :1405   Median :1400  
##  Mean   :2013   Mean   : 6.52   Mean   :15.6   Mean   :1347   Mean   :1346  
##  3rd Qu.:2013   3rd Qu.: 9.00   3rd Qu.:23.0   3rd Qu.:1741   3rd Qu.:1729  
##  Max.   :2013   Max.   :12.00   Max.   :31.0   Max.   :2359   Max.   :2359  
##                                                NA's   :125                  
##    dep_delay        arr_time    sched_arr_time   arr_delay    
##  Min.   :-20.0   Min.   :   1   Min.   :   1   Min.   :-66.0  
##  1st Qu.: -5.0   1st Qu.:1102   1st Qu.:1120   1st Qu.:-16.0  
##  Median : -1.0   Median :1535   Median :1556   Median : -4.0  
##  Mean   : 12.8   Mean   :1494   Mean   :1528   Mean   :  7.1  
##  3rd Qu.: 11.0   3rd Qu.:1930   3rd Qu.:1939   3rd Qu.: 14.0  
##  Max.   :486.0   Max.   :2359   Max.   :2359   Max.   :492.0  
##  NA's   :125     NA's   :130                   NA's   :142    
##    carrier              flight       tailnum             origin         
##  Length:5000        Min.   :   1   Length:5000        Length:5000       
##  Class :character   1st Qu.: 597   Class :character   Class :character  
##  Mode  :character   Median :1530   Mode  :character   Mode  :character  
##                     Mean   :1986                                        
##                     3rd Qu.:3486                                        
##                     Max.   :6177                                        
##                                                                         
##      dest              air_time      distance         hour          minute    
##  Length:5000        Min.   : 24   Min.   :  94   Min.   : 5.0   Min.   : 0.0  
##  Class :character   1st Qu.: 81   1st Qu.: 502   1st Qu.: 9.0   1st Qu.: 8.0  
##  Mode  :character   Median :128   Median : 872   Median :14.0   Median :29.0  
##                     Mean   :149   Mean   :1030   Mean   :13.2   Mean   :26.4  
##                     3rd Qu.:189   3rd Qu.:1389   3rd Qu.:17.0   3rd Qu.:44.0  
##                     Max.   :639   Max.   :4983   Max.   :23.0   Max.   :59.0  
##                     NA's   :142                                               
##    time_hour                  
##  Min.   :2013-01-01 07:00:00  
##  1st Qu.:2013-04-02 19:45:00  
##  Median :2013-07-04 17:30:00  
##  Mean   :2013-07-02 08:08:39  
##  3rd Qu.:2013-09-30 08:00:00  
##  Max.   :2013-12-31 21:00:00  
## 
```
---


```r
flight_data &lt;- 
  flights %&gt;% 
  mutate(
    # Convert the arrival delay to a factor
    arr_delay = ifelse(arr_delay &gt;= 30, "late", "on_time"),
    arr_delay = factor(arr_delay),
    # We will use the date (not date-time) in the recipe below
    date = as.Date(time_hour)
  ) %&gt;% 
  # Include the weather data
  inner_join(weather, by = c("origin", "time_hour")) %&gt;% 
  # Only retain the specific columns we will use
  select(dep_time, flight, origin, dest, air_time, distance, 
         carrier, date, arr_delay, time_hour) %&gt;% 
  # Exclude missing data
  drop_na() %&gt;% 
  # For creating models, it is better to have qualitative columns
  # encoded as factors (instead of character strings)
  mutate_if(is.character, as.factor)
```


---
class: center, middle, inverse

## Specify the model

---
## Specify the model

In `tidymodels`, you need three pieces of information to **specify** a model:

1. The **type** of model.

2. The **engine** - i.e., which R package implementation you will rely on

3. The **mode**: classification or regression.

--

*Optional* information: various parameters of the model

---
## Specify the model


```r
lin_mod_spec &lt;- linear_reg() %&gt;%
  set_mode("regression") %&gt;%
  set_engine("lm")


logistic_mod_spec &lt;- logistic_reg() %&gt;%
  set_mode("classification") %&gt;%
  set_engine("glm")
```

--

**NOTE:** We have not said anything about the dataset here!

---
class: center, middle, inverse

## Recipe for pre-processing

---

## Recipes

**Pre-processing** includes things like:

* **Transforming** variables to be approximately Normal

* Dealing with **missing data**

* **Omitting** certain variables from the model.

* Converting categorical variables to **dummy variables**.

* Adding **interaction terms** to your model

* *(Advanced)* Applying **dimension reduction** to the data.

--

*These are all model-related choices!!!*

---

## Recipes

All a `recipe` **needs** to have is a *formula* and a *dataset*:


```r
flights_rec &lt;- 
  recipe(arr_delay ~ ., data = flight_data) 
```

--

Note 1:  The ` ~ .` means "use all available columns" as predictors.  Handy, but dangerous!

--

Note 2: Here `flight_data` is a kind of "example data structure".  It tells the recipe what we can expect, but nothing is computed yet.

---

## Recipes

Now we can add other pre-processing steps to the recipe:

--

Note that the `flight` and `time_hour` columns uniquely identify each flight, and should not be used:


```r
flights_rec &lt;- 
  recipe(arr_delay ~ ., data = flight_data) %&gt;% 
  update_role(flight, time_hour, new_role = "ID") 
```

---

Instead of using the `date` column as it stands, let's just note important dates:


```r
flights_rec &lt;- 
  recipe(arr_delay ~ ., data = flight_data) %&gt;% 
  update_role(flight, time_hour, new_role = "ID") %&gt;% 
  step_date(date, features = c("dow", "month")) %&gt;%               
  step_holiday(date, holidays = timeDate::listHolidays("US")) %&gt;% 
  step_rm(date)
```

---

Turn all categorical variables into dummy variables, and drop any predictors that have only one observation:


```r
flights_rec &lt;- 
  recipe(arr_delay ~ ., data = flight_data) %&gt;% 
  update_role(flight, time_hour, new_role = "ID") %&gt;% 
  step_date(date, features = c("dow", "month")) %&gt;%               
  step_holiday(date, holidays = timeDate::listHolidays("US")) %&gt;% 
  step_rm(date) %&gt;% 
  step_dummy(all_nominal(), -all_outcomes()) %&gt;% 
  step_zv(all_predictors())
```

---
## Final Recipe


```r
flights_rec
```

```
## Data Recipe
## 
## Inputs:
## 
##       role #variables
##         ID          2
##    outcome          1
##  predictor          7
## 
## Operations:
## 
## Date features from date
## Holiday features from date
## Delete terms date
## Dummy variables from all_nominal(), -all_outcomes()
## Zero variance filter on all_predictors()
```

---
class: center, middle, inverse

## Make a workflow

---

## Workflow


```r
flights_wflow &lt;- workflow() %&gt;%
  add_model(logistic_mod_spec) %&gt;%
  add_recipe(flights_rec)
```

--

**Nothing has yet been calculated!!!**


---
class: center, middle, inverse

## Fit the model

---

## Fitting directly on data


```r
model_fit &lt;- flights_wflow %&gt;%
  fit(flight_data)

summary(model_fit)
```

```
##         Length Class      Mode   
## pre     2      stage_pre  list   
## fit     2      stage_fit  list   
## post    1      stage_post list   
## trained 1      -none-     logical
```

---


```r
model_fit %&gt;% pull_workflow_fit()
```

```
## parsnip model object
## 
## Fit time:  1.2s 
## 
## Call:  stats::glm(formula = ..y ~ ., family = stats::binomial, data = data)
## 
## Coefficients:
##                  (Intercept)                      dep_time  
##                      2.93211                      -0.00155  
##                     air_time                      distance  
##                     -0.04259                       0.01586  
##          date_USChristmasDay            date_USColumbusDay  
##                      1.14961                      14.48736  
##     date_USCPulaskisBirthday  date_USDecorationMemorialDay  
##                     15.08385                       1.48787  
##           date_USElectionDay             date_USGoodFriday  
##                     -0.04447                       0.45333  
##       date_USInaugurationDay        date_USIndependenceDay  
##                     -0.39720                       0.22503  
##              date_USLaborDay       date_USLincolnsBirthday  
##                     -1.26795                      14.88197  
##           date_USMemorialDay        date_USMLKingsBirthday  
##                     15.66948                      15.22241  
##           date_USNewYearsDay          date_USPresidentsDay  
##                     -0.16418                      14.53802  
##       date_USThanksgivingDay            date_USVeteransDay  
##                     -0.83406                      -0.12743  
##   date_USWashingtonsBirthday                    origin_JFK  
##                      0.65199                      -0.06369  
##                   origin_LGA                      dest_ACK  
##                      0.02859                      -0.13270  
##                     dest_ALB                      dest_ATL  
##                      0.86252                      -6.09171  
##                     dest_AUS                      dest_AVL  
##                    -13.41358                      -3.84350  
##                     dest_BDL                      dest_BGR  
##                     -0.32773                      13.35316  
##                     dest_BHM                      dest_BNA  
##                     -6.67771                      -5.48142  
##                     dest_BOS                      dest_BQN  
##                      0.72488                     -15.72211  
##                     dest_BTV                      dest_BUF  
##                      0.00645                      -0.40406  
##                     dest_BUR                      dest_BWI  
##                    -22.05750                      -0.35830  
##                     dest_CAE                      dest_CAK  
##                    -20.12594                      -2.13327  
##                     dest_CHO                      dest_CHS  
##                     15.28950                      -4.05004  
##                     dest_CLE                      dest_CLT  
##                     -2.03106                      -3.35491  
##                     dest_CMH                      dest_CRW  
##                     -2.98024                      12.84843  
##                     dest_CVG                      dest_DAY  
##                     -3.88570                      -3.01262  
##                     dest_DCA                      dest_DEN  
##                      0.34207                     -14.52170  
##                     dest_DFW                      dest_DSM  
##                    -12.47915                      -8.20191  
##                     dest_DTW                      dest_EGE  
##                     -2.65291                      -0.75218  
##                     dest_FLL                      dest_GRR  
##                     -9.30054                      -3.41709  
##                     dest_GSO                      dest_GSP  
##                     -2.70671                      -3.58489  
##                     dest_HNL                      dest_HOU  
##                    -38.23466                     -11.80913  
##                     dest_IAD                      dest_IAH  
##                      0.11088                     -12.77118  
##                     dest_ILM                      dest_IND  
##                     13.07385                      -4.97202  
##                     dest_JAC                      dest_JAX  
##                     -4.75663                      -6.33834  
##                     dest_LAS                      dest_LAX  
##                    -21.30253                     -23.51161  
##                     dest_LGB                      dest_MCI  
##                     -8.47538                      -7.91718  
##                     dest_MCO                      dest_MDW  
##                     -7.89544                      -5.34430  
##                     dest_MEM                      dest_MHT  
##                     -7.62673                      -0.17791  
##                     dest_MIA                      dest_MKE  
##                     -9.37548                      -5.33586  
##                     dest_MSN                      dest_MSP  
##                     -5.83548                      -7.85036  
##                     dest_MSY                      dest_MVY  
##                     -9.51076                      -0.03982  
##                     dest_MYR                      dest_OAK  
##                      9.80415                      -9.22404  
##                     dest_OKC                      dest_OMA  
##                      5.08906                      -9.51126  
##                     dest_ORD                      dest_ORF  
##                     -5.76742                      -0.55712  
##                     dest_PBI                      dest_PDX  
##                     -8.63088                     -23.49463  
##                     dest_PHL                      dest_PHX  
##                      1.06879                     -19.69762  
##                     dest_PIT                      dest_PSE  
##                     -0.85276                     -18.37871  
##                     dest_PSP                      dest_PVD  
##                     -8.49725                     -16.10372  
##                     dest_PWM                      dest_RDU  
##                     -0.02057                      -2.10058  
##                     dest_RIC                      dest_ROC  
##                     -0.21202                      -0.92975  
##                     dest_RSW                      dest_SAN  
##                     -8.34075                     -24.13795  
##                     dest_SAT                      dest_SAV  
##                    -13.62218                       9.33359  
##                     dest_SDF                      dest_SEA  
##                     -2.04597                     -22.60321  
##                     dest_SFO                      dest_SJC  
##                    -24.67357                      -8.72849  
##                     dest_SJU                      dest_SLC  
##                    -15.54135                     -16.53267  
##                     dest_SMF                      dest_SNA  
##                    -22.83185                     -23.19804  
##                     dest_SRQ                      dest_STL  
##                    -10.04972                      -6.45010  
##                     dest_STT                      dest_SYR  
##                     -1.84563                      -0.01488  
##                     dest_TPA                      dest_TUL  
##                     -8.41585                      -9.60757  
##                     dest_TYS                      dest_XNA  
##                     -4.60428                      -7.89731  
##                   carrier_AA                    carrier_AS  
##                      0.68994                      15.45232  
##                   carrier_B6                    carrier_DL  
##                      0.00367                       0.65525  
##                   carrier_EV                    carrier_F9  
##                     -0.66851                      -1.39046  
##                   carrier_FL                    carrier_HA  
##                      0.04501                       1.59222  
##                   carrier_MQ                    carrier_OO  
##                      0.02025                      -1.19188  
##                   carrier_UA                    carrier_US  
##                      0.81183                       0.37117  
##                   carrier_VX                    carrier_WN  
##                      1.07438                       0.50973  
##                   carrier_YV                  date_dow_Mon  
##                     14.48325                      -0.64079  
##                 date_dow_Tue                  date_dow_Wed  
##                     -0.21111                      -0.22942  
##                 date_dow_Thu                  date_dow_Fri  
##                     -0.65823                      -0.71568  
##                 date_dow_Sat                date_month_Feb  
##                      0.22063                       0.07683  
##               date_month_Mar                date_month_Apr  
##                     -0.05532                      -0.33997  
##               date_month_May                date_month_Jun  
##                     -0.63275                      -1.21239  
##               date_month_Jul                date_month_Aug  
##                     -1.09018                      -0.63224  
##               date_month_Sep                date_month_Oct  
##                      0.15750                       0.22663  
##               date_month_Nov                date_month_Dec  
##                      0.47505                      -0.44244  
## 
## Degrees of Freedom: 4834 Total (i.e. Null);  4685 Residual
## Null Deviance:	    4370 
## Residual Deviance: 3550 	AIC: 3850
```

---


```r
wflow_fit &lt;- model_fit %&gt;% pull_workflow_fit() 

wflow_fit$fit %&gt;% summary()
```

```
## 
## Call:
## stats::glm(formula = ..y ~ ., family = stats::binomial, data = data)
## 
## Deviance Residuals: 
##    Min      1Q  Median      3Q     Max  
## -3.251   0.203   0.386   0.602   2.635  
## 
## Coefficients:
##                                  Estimate   Std. Error z value
## (Intercept)                     2.9321072 1694.0957970    0.00
## dep_time                       -0.0015541    0.0000999  -15.56
## air_time                       -0.0425943    0.0040635  -10.48
## distance                        0.0158571    0.0108230    1.47
## date_USChristmasDay             1.1496097    1.1247047    1.02
## date_USColumbusDay             14.4873627  543.3105064    0.03
## date_USCPulaskisBirthday       15.0838464  698.2155979    0.02
## date_USDecorationMemorialDay    1.4878703    1.0948357    1.36
## date_USElectionDay             -0.0444701    1.1057778   -0.04
## date_USGoodFriday               0.4533331    0.7132510    0.64
## date_USInaugurationDay         -0.3972031    1.1933514   -0.33
## date_USIndependenceDay          0.2250341    0.5887513    0.38
## date_USLaborDay                -1.2679471    0.5825210   -2.18
## date_USLincolnsBirthday        14.8819663  802.4804450    0.02
## date_USMemorialDay             15.6694775  805.1668921    0.02
## date_USMLKingsBirthday         15.2224093  674.2622298    0.02
## date_USNewYearsDay             -0.1641793    0.8697114   -0.19
## date_USPresidentsDay           14.5380186  619.6055059    0.02
## date_USThanksgivingDay         -0.8340634    0.8871796   -0.94
## date_USVeteransDay             -0.1274273    1.1878143   -0.11
## date_USWashingtonsBirthday      0.6519909    0.8142030    0.80
## origin_JFK                     -0.0636911    0.2042365   -0.31
## origin_LGA                      0.0285903    0.2006960    0.14
## dest_ACK                       -0.1326969 1694.0737525    0.00
## dest_ALB                        0.8625214 1694.0785001    0.00
## dest_ATL                       -6.0917094 1694.0214036    0.00
## dest_AUS                      -13.4135846 1693.9855032   -0.01
## dest_AVL                       -3.8434993 1694.0347145    0.00
## dest_BDL                       -0.3277323 1694.0816626    0.00
## dest_BGR                       13.3531570 1881.3207656    0.01
## dest_BHM                       -6.6777129 1694.0143065    0.00
## dest_BNA                       -5.4814227 1694.0211817    0.00
## dest_BOS                        0.7248831 1694.0737911    0.00
## dest_BQN                      -15.7221136 1693.9843581   -0.01
## dest_BTV                        0.0064455 1694.0656183    0.00
## dest_BUF                       -0.4040600 1694.0625633    0.00
## dest_BUR                      -22.0575029 1693.9966335   -0.01
## dest_BWI                       -0.3582971 1694.0752466    0.00
## dest_CAE                      -20.1259381 2937.2710289   -0.01
## dest_CAK                       -2.1332693 1694.0530546    0.00
## dest_CHO                       15.2894965 2937.2879770    0.01
## dest_CHS                       -4.0500433 1694.0307245    0.00
## dest_CLE                       -2.0310644 1694.0505044    0.00
## dest_CLT                       -3.3549109 1694.0388249    0.00
## dest_CMH                       -2.9802394 1694.0448142    0.00
## dest_CRW                       12.8484272 2396.3725595    0.01
## dest_CVG                       -3.8856952 1694.0354580    0.00
## dest_DAY                       -3.0126246 1694.0387234    0.00
## dest_DCA                        0.3420665 1694.0717286    0.00
## dest_DEN                      -14.5216992 1693.9836753   -0.01
## dest_DFW                      -12.4791548 1693.9888881   -0.01
## dest_DSM                       -8.2019135 1694.0042493    0.00
## dest_DTW                       -2.6529145 1694.0426231    0.00
## dest_EGE                       -0.7521773 2937.2421592    0.00
## dest_FLL                       -9.3005387 1694.0017610   -0.01
## dest_GRR                       -3.4170938 1694.0326013    0.00
## dest_GSO                       -2.7067140 1694.0466328    0.00
## dest_GSP                       -3.5848949 1694.0334840    0.00
## dest_HNL                      -38.2346632 2937.4391651   -0.01
## dest_HOU                      -11.8091341 1693.9878156   -0.01
## dest_IAD                        0.1108788 1694.0701761    0.00
## dest_IAH                      -12.7711842 1693.9880978   -0.01
## dest_ILM                       13.0738523 2937.2769454    0.00
## dest_IND                       -4.9720177 1694.0290432    0.00
## dest_JAC                       -4.7566305 2937.2420771    0.00
## dest_JAX                       -6.3383410 1694.0163716    0.00
## dest_LAS                      -21.3025263 1693.9882813   -0.01
## dest_LAX                      -23.5116142 1693.9965834   -0.01
## dest_LGB                       -8.4753762 2015.3935706    0.00
## dest_MCI                       -7.9171752 1694.0001688    0.00
## dest_MCO                       -7.8954396 1694.0088481    0.00
## dest_MDW                       -5.3443028 1694.0240036    0.00
## dest_MEM                       -7.6267293 1694.0081711    0.00
## dest_MHT                       -0.1779117 1694.0718408    0.00
## dest_MIA                       -9.3754758 1694.0007195   -0.01
## dest_MKE                       -5.3358572 1694.0229777    0.00
## dest_MSN                       -5.8354788 1694.0180421    0.00
## dest_MSP                       -7.8503602 1694.0044828    0.00
## dest_MSY                       -9.5107597 1693.9965663   -0.01
## dest_MVY                       -0.0398246 1694.0767258    0.00
## dest_MYR                        9.8041520 2937.2737130    0.00
## dest_OAK                       -9.2240387 2042.4079128    0.00
## dest_OKC                        5.0890559 2179.2123333    0.00
## dest_OMA                       -9.5112615 1693.9981800   -0.01
## dest_ORD                       -5.7674155 1694.0233601    0.00
## dest_ORF                       -0.5571174 1694.0632959    0.00
## dest_PBI                       -8.6308787 1694.0039099   -0.01
## dest_PDX                      -23.4946345 1693.9957088   -0.01
## dest_PHL                        1.0687879 1694.0855478    0.00
## dest_PHX                      -19.6976188 1693.9859023   -0.01
## dest_PIT                       -0.8527607 1694.0587250    0.00
## dest_PSE                      -18.3787054 1693.9840684   -0.01
## dest_PSP                       -8.4972479 2937.2480775    0.00
## dest_PVD                      -16.1037233 2397.3766049   -0.01
## dest_PWM                       -0.0205745 1694.0641400    0.00
## dest_RDU                       -2.1005770 1694.0495131    0.00
## dest_RIC                       -0.2120162 1694.0635297    0.00
## dest_ROC                       -0.9297506 1694.0665009    0.00
## dest_RSW                       -8.3407513 1694.0015812    0.00
## dest_SAN                      -24.1379466 1693.9953525   -0.01
## dest_SAT                      -13.6221782 1693.9844044   -0.01
## dest_SAV                        9.3335928 2052.3813919    0.00
## dest_SDF                       -2.0459749 1694.0297535    0.00
## dest_SEA                      -22.6032146 1693.9944003   -0.01
## dest_SFO                      -24.6735656 1694.0019348   -0.01
## dest_SJC                       -8.7284929 2054.5984367    0.00
## dest_SJU                      -15.5413504 1693.9839757   -0.01
## dest_SLC                      -16.5326670 1693.9834202   -0.01
## dest_SMF                      -22.8318520 1693.9993366   -0.01
## dest_SNA                      -23.1980358 1693.9958252   -0.01
## dest_SRQ                      -10.0497221 1694.0033851   -0.01
## dest_STL                       -6.4500980 1694.0126862    0.00
## dest_STT                       -1.8456348 1877.8556182    0.00
## dest_SYR                       -0.0148812 1694.0726538    0.00
## dest_TPA                       -8.4158479 1694.0053427    0.00
## dest_TUL                       -9.6075719 1693.9949493   -0.01
## dest_TYS                       -4.6042802 1694.0304897    0.00
## dest_XNA                       -7.8973104 1693.9984683    0.00
## carrier_AA                      0.6899410    0.2898641    2.38
## carrier_AS                     15.4523155  597.1708177    0.03
## carrier_B6                      0.0036721    0.2318027    0.02
## carrier_DL                      0.6552479    0.2501280    2.62
## carrier_EV                     -0.6685068    0.2436626   -2.74
## carrier_F9                     -1.3904586    0.9225118   -1.51
## carrier_FL                      0.0450144    0.6333821    0.07
## carrier_HA                      1.5922155 2752.3403383    0.00
## carrier_MQ                      0.0202486    0.2448899    0.08
## carrier_OO                     -1.1918779    1.5588549   -0.76
## carrier_UA                      0.8118333    0.2789723    2.91
## carrier_US                      0.3711706    0.3287895    1.13
## carrier_VX                      1.0743803    0.4920524    2.18
## carrier_WN                      0.5097335    0.4364776    1.17
## carrier_YV                     14.4832477 1348.8083871    0.01
## date_dow_Mon                   -0.6407940    0.1748735   -3.66
## date_dow_Tue                   -0.2111141    0.1785696   -1.18
## date_dow_Wed                   -0.2294205    0.1766963   -1.30
## date_dow_Thu                   -0.6582324    0.1709256   -3.85
## date_dow_Fri                   -0.7156757    0.1717292   -4.17
## date_dow_Sat                    0.2206322    0.1971282    1.12
## date_month_Feb                  0.0768341    0.2278125    0.34
## date_month_Mar                 -0.0553223    0.2256274   -0.25
## date_month_Apr                 -0.3399715    0.2077451   -1.64
## date_month_May                 -0.6327516    0.2231056   -2.84
## date_month_Jun                 -1.2123936    0.2097715   -5.78
## date_month_Jul                 -1.0901799    0.2116120   -5.15
## date_month_Aug                 -0.6322393    0.2131579   -2.97
## date_month_Sep                  0.1575015    0.2528212    0.62
## date_month_Oct                  0.2266333    0.2389965    0.95
## date_month_Nov                  0.4750476    0.2430536    1.95
## date_month_Dec                 -0.4424420    0.2077536   -2.13
##                                          Pr(&gt;|z|)    
## (Intercept)                               0.99862    
## dep_time                     &lt; 0.0000000000000002 ***
## air_time                     &lt; 0.0000000000000002 ***
## distance                                  0.14288    
## date_USChristmasDay                       0.30671    
## date_USColumbusDay                        0.97873    
## date_USCPulaskisBirthday                  0.98276    
## date_USDecorationMemorialDay              0.17415    
## date_USElectionDay                        0.96792    
## date_USGoodFriday                         0.52505    
## date_USInaugurationDay                    0.73925    
## date_USIndependenceDay                    0.70230    
## date_USLaborDay                           0.02951 *  
## date_USLincolnsBirthday                   0.98520    
## date_USMemorialDay                        0.98447    
## date_USMLKingsBirthday                    0.98199    
## date_USNewYearsDay                        0.85027    
## date_USPresidentsDay                      0.98128    
## date_USThanksgivingDay                    0.34715    
## date_USVeteransDay                        0.91457    
## date_USWashingtonsBirthday                0.42326    
## origin_JFK                                0.75515    
## origin_LGA                                0.88672    
## dest_ACK                                  0.99994    
## dest_ALB                                  0.99959    
## dest_ATL                                  0.99713    
## dest_AUS                                  0.99368    
## dest_AVL                                  0.99819    
## dest_BDL                                  0.99985    
## dest_BGR                                  0.99434    
## dest_BHM                                  0.99685    
## dest_BNA                                  0.99742    
## dest_BOS                                  0.99966    
## dest_BQN                                  0.99259    
## dest_BTV                                  1.00000    
## dest_BUF                                  0.99981    
## dest_BUR                                  0.98961    
## dest_BWI                                  0.99983    
## dest_CAE                                  0.99453    
## dest_CAK                                  0.99900    
## dest_CHO                                  0.99585    
## dest_CHS                                  0.99809    
## dest_CLE                                  0.99904    
## dest_CLT                                  0.99842    
## dest_CMH                                  0.99860    
## dest_CRW                                  0.99572    
## dest_CVG                                  0.99817    
## dest_DAY                                  0.99858    
## dest_DCA                                  0.99984    
## dest_DEN                                  0.99316    
## dest_DFW                                  0.99412    
## dest_DSM                                  0.99614    
## dest_DTW                                  0.99875    
## dest_EGE                                  0.99980    
## dest_FLL                                  0.99562    
## dest_GRR                                  0.99839    
## dest_GSO                                  0.99873    
## dest_GSP                                  0.99831    
## dest_HNL                                  0.98961    
## dest_HOU                                  0.99444    
## dest_IAD                                  0.99995    
## dest_IAH                                  0.99398    
## dest_ILM                                  0.99645    
## dest_IND                                  0.99766    
## dest_JAC                                  0.99871    
## dest_JAX                                  0.99701    
## dest_LAS                                  0.98997    
## dest_LAX                                  0.98893    
## dest_LGB                                  0.99664    
## dest_MCI                                  0.99627    
## dest_MCO                                  0.99628    
## dest_MDW                                  0.99748    
## dest_MEM                                  0.99641    
## dest_MHT                                  0.99992    
## dest_MIA                                  0.99558    
## dest_MKE                                  0.99749    
## dest_MSN                                  0.99725    
## dest_MSP                                  0.99630    
## dest_MSY                                  0.99552    
## dest_MVY                                  0.99998    
## dest_MYR                                  0.99734    
## dest_OAK                                  0.99640    
## dest_OKC                                  0.99814    
## dest_OMA                                  0.99552    
## dest_ORD                                  0.99728    
## dest_ORF                                  0.99974    
## dest_PBI                                  0.99593    
## dest_PDX                                  0.98893    
## dest_PHL                                  0.99950    
## dest_PHX                                  0.99072    
## dest_PIT                                  0.99960    
## dest_PSE                                  0.99134    
## dest_PSP                                  0.99769    
## dest_PVD                                  0.99464    
## dest_PWM                                  0.99999    
## dest_RDU                                  0.99901    
## dest_RIC                                  0.99990    
## dest_ROC                                  0.99956    
## dest_RSW                                  0.99607    
## dest_SAN                                  0.98863    
## dest_SAT                                  0.99358    
## dest_SAV                                  0.99637    
## dest_SDF                                  0.99904    
## dest_SEA                                  0.98935    
## dest_SFO                                  0.98838    
## dest_SJC                                  0.99661    
## dest_SJU                                  0.99268    
## dest_SLC                                  0.99221    
## dest_SMF                                  0.98925    
## dest_SNA                                  0.98907    
## dest_SRQ                                  0.99527    
## dest_STL                                  0.99696    
## dest_STT                                  0.99922    
## dest_SYR                                  0.99999    
## dest_TPA                                  0.99604    
## dest_TUL                                  0.99547    
## dest_TYS                                  0.99783    
## dest_XNA                                  0.99628    
## carrier_AA                                0.01730 *  
## carrier_AS                                0.97936    
## carrier_B6                                0.98736    
## carrier_DL                                0.00880 ** 
## carrier_EV                                0.00608 ** 
## carrier_F9                                0.13175    
## carrier_FL                                0.94334    
## carrier_HA                                0.99954    
## carrier_MQ                                0.93410    
## carrier_OO                                0.44452    
## carrier_UA                                0.00361 ** 
## carrier_US                                0.25894    
## carrier_VX                                0.02900 *  
## carrier_WN                                0.24287    
## carrier_YV                                0.99143    
## date_dow_Mon                              0.00025 ***
## date_dow_Tue                              0.23711    
## date_dow_Wed                              0.19415    
## date_dow_Thu                              0.00012 ***
## date_dow_Fri                         0.0000308005 ***
## date_dow_Sat                              0.26304    
## date_month_Feb                            0.73591    
## date_month_Mar                            0.80631    
## date_month_Apr                            0.10174    
## date_month_May                            0.00457 ** 
## date_month_Jun                       0.0000000075 ***
## date_month_Jul                       0.0000002580 ***
## date_month_Aug                            0.00302 ** 
## date_month_Sep                            0.53330    
## date_month_Oct                            0.34299    
## date_month_Nov                            0.05064 .  
## date_month_Dec                            0.03320 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 4370.3  on 4834  degrees of freedom
## Residual deviance: 3551.3  on 4685  degrees of freedom
## AIC: 3851
## 
## Number of Fisher Scoring iterations: 15
```

---


```r
model_fit %&gt;% pull_workflow_fit()  %&gt;% tidy()
```

```
## # A tibble: 150 x 5
##    term                         estimate    std.error statistic  p.value
##    &lt;chr&gt;                           &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1 (Intercept)                   2.93    1694.          0.00173 9.99e- 1
##  2 dep_time                     -0.00155    0.0000999 -15.6     1.36e-54
##  3 air_time                     -0.0426     0.00406   -10.5     1.04e-25
##  4 distance                      0.0159     0.0108      1.47    1.43e- 1
##  5 date_USChristmasDay           1.15       1.12        1.02    3.07e- 1
##  6 date_USColumbusDay           14.5      543.          0.0267  9.79e- 1
##  7 date_USCPulaskisBirthday     15.1      698.          0.0216  9.83e- 1
##  8 date_USDecorationMemorialDay  1.49       1.09        1.36    1.74e- 1
##  9 date_USElectionDay           -0.0445     1.11       -0.0402  9.68e- 1
## 10 date_USGoodFriday             0.453      0.713       0.636   5.25e- 1
## # … with 140 more rows
```



---
class: center, middle

## Evaluate the model

---

## Test/Training

We would like to know how this model will do on *future data*, not just how it fit on the *currently observed* data.

--

Let's set aside 25% of our data to be a "test set":  It will not be used in the **model fitting**, but it will be used for **model evaluation**.

---

## Test/training



```r
# Put 3/4 of the data into the training set 
data_split &lt;- initial_split(flight_data, prop = 3/4)

# Create data frames for the two sets:
train_data &lt;- training(data_split)
test_data  &lt;- testing(data_split)
```

---

## First, fit the model on the training data:


```r
model_fit &lt;- flights_wflow %&gt;%
  fit(train_data)
```

---

## Then, evaluate the model on the test data:


```r
predict(model_fit, test_data)
```

```
## # A tibble: 1,209 x 1
##    .pred_class
##    &lt;fct&gt;      
##  1 on_time    
##  2 on_time    
##  3 on_time    
##  4 on_time    
##  5 on_time    
##  6 on_time    
##  7 on_time    
##  8 on_time    
##  9 on_time    
## 10 on_time    
## # … with 1,199 more rows
```

---


```r
predict(model_fit, test_data, type = "prob")
```

```
## # A tibble: 1,209 x 2
##    .pred_late .pred_on_time
##         &lt;dbl&gt;         &lt;dbl&gt;
##  1     0.201          0.799
##  2     0.0150         0.985
##  3     0.156          0.844
##  4     0.213          0.787
##  5     0.142          0.858
##  6     0.166          0.834
##  7     0.106          0.894
##  8     0.313          0.687
##  9     0.0826         0.917
## 10     0.166          0.834
## # … with 1,199 more rows
```

---

## Comparing predictions to reality


```r
flights_pred &lt;- test_data %&gt;% 
        select(arr_delay, time_hour, flight) %&gt;%
  bind_cols(
    predict(model_fit, test_data),
    predict(model_fit, test_data, type = "prob")
  )

flights_pred
```

```
## # A tibble: 1,209 x 6
##    arr_delay time_hour           flight .pred_class .pred_late .pred_on_time
##    &lt;fct&gt;     &lt;dttm&gt;               &lt;int&gt; &lt;fct&gt;            &lt;dbl&gt;         &lt;dbl&gt;
##  1 late      2013-07-07 16:00:00    881 on_time         0.201          0.799
##  2 on_time   2013-01-26 06:00:00   1415 on_time         0.0150         0.985
##  3 on_time   2013-12-02 10:00:00    925 on_time         0.156          0.844
##  4 on_time   2013-09-30 20:00:00   5956 on_time         0.213          0.787
##  5 on_time   2013-02-06 21:00:00   2144 on_time         0.142          0.858
##  6 on_time   2013-03-27 17:00:00   4479 on_time         0.166          0.834
##  7 on_time   2013-07-23 10:00:00    673 on_time         0.106          0.894
##  8 on_time   2013-03-05 16:00:00    917 on_time         0.313          0.687
##  9 on_time   2013-10-26 14:00:00   1171 on_time         0.0826         0.917
## 10 late      2013-11-01 08:00:00   4638 on_time         0.166          0.834
## # … with 1,199 more rows
```

---
## Comparing predictions to reality


```r
flights_pred %&gt;%
  count(.pred_class,
        arr_delay)
```

```
## # A tibble: 4 x 3
##   .pred_class arr_delay     n
##   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;
## 1 late        late         32
## 2 late        on_time      23
## 3 on_time     late        169
## 4 on_time     on_time     985
```
---


```r
flights_pred %&gt;%
  ggplot(aes(x = .pred_late, fill = arr_delay)) +
  geom_density(alpha = 0.5)
```

![](02-Tidymodels_files/figure-html/unnamed-chunk-21-1.png)&lt;!-- --&gt;

---

## Evaluating by metrics


```r
flights_pred %&gt;%
  accuracy(estimate = .pred_class,
           truth = arr_delay)
```

```
## # A tibble: 1 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.841
```

---


```r
flights_pred %&gt;% 
  roc_curve(truth = arr_delay, .pred_late) %&gt;% 
  autoplot()
```

![](02-Tidymodels_files/figure-html/unnamed-chunk-23-1.png)&lt;!-- --&gt;

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightLines": true,
"highlightStyle": "github",
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
